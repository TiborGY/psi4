#! CC2(RHF)/cc-pVDZ energy of H2O - Regression test for t2.cc:48 logic bug
#!
#! BUG DESCRIPTION:
#! ================
#! File: psi4/src/psi4/cc/ccenergy/t2.cc, line 48
#!
#! Buggy code:
#!   if (params_.wfn != "CC2" || params_.wfn != "EOM_CC2") {
#!       FaetT2();  // CCSD-specific terms
#!       FmitT2();  // CCSD-specific terms
#!       // ... more CCSD terms
#!   }
#!
#! Problem: The OR (||) operator makes this condition ALWAYS TRUE:
#!   - If wfn == "CC2": wfn != "EOM_CC2" is true → condition is true
#!   - If wfn == "EOM_CC2": wfn != "CC2" is true → condition is true
#!   - If wfn == "CCSD": both are true → condition is true
#!
#! Correct code should use AND (&&):
#!   if (params_.wfn != "CC2" && params_.wfn != "EOM_CC2") {
#!
#! Impact: If t2_build() is called for CC2/EOM_CC2 (e.g., in one_step() with
#! just_residuals), it would incorrectly execute CCSD terms instead of using
#! the proper CC2 approximation (which uses only T1-based intermediates).
#!
#! NOTE: Normal CC2 calculations call cc2_t2_build() instead of t2_build(),
#! so they are not affected. This test serves as a regression test and
#! documentation of the correct behavior.

# H2O geometry from Olsen et al., JCP 104, 8007 (1996)
molecule h2o {
  0 1
  O 0.0  0.00000000 -0.00900000
  H 0.0 -1.51526300 -1.05889800
  H 0.0  1.51526300 -1.05889800
  units bohr
}

set {
  basis cc-pVDZ
  freeze_core false
}

# Run CC2 calculation
# This calls cc2_t2_build() which is correct and not affected by the bug
ecc2 = energy('cc2')

# Reference values (from cc36 test)
enuc = 9.00935422966266      # TEST
escf = -76.02403851151333     # TEST
ecc2_ref = -76.22960579193078 # TEST

compare_values(enuc, h2o.nuclear_repulsion_energy(), 9, "Nuclear repulsion energy") # TEST
compare_values(escf, variable("SCF TOTAL ENERGY"), 7, "SCF energy") # TEST
compare_values(ecc2_ref, ecc2, 7, "CC2 energy") # TEST

# For additional verification, run CCSD
# CC2 should give slightly higher energy than CCSD (less correlation recovered)
eccsd = energy('ccsd')
eccsd_ref = -76.24046955364111 # TEST

compare_values(eccsd_ref, eccsd, 7, "CCSD energy") # TEST

# Verify CC2 > CCSD (CC2 recovers less correlation)
energy_diff = ecc2 - eccsd
print(f"\nEnergy difference (CC2 - CCSD): {energy_diff:.10f} Ha")
print(f"CC2 energy should be higher than CCSD: {ecc2 > eccsd}")

# This assertion documents the expected behavior:
# CC2 uses T1-only intermediates (O(N^5) scaling)
# CCSD uses T1+T2 intermediates (O(N^6) scaling)
# Therefore, CC2 recovers less correlation and has higher energy
if ecc2 <= eccsd:
    raise ValueError("ERROR: CC2 energy should be higher than CCSD energy!\n" +
                     "This may indicate the logic bug at t2.cc:48 is affecting results.")
